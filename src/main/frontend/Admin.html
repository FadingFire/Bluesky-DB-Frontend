<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="CSS/Admin.css">
    <title>Adminpage</title>
</head>
<body>
    <div class="container">

        <div class="title">
            <h1>Flights Database</h1>
        </div>

        <div id="table">
            <div id="output" class="output-container">
            </div>

            <div class="pagination-container">
                <button onclick="pagedown()">pagedown</button>
                <p id="page">Page: 1</p>
                <button onclick="pageup()">pageup</button>
            </div>

            <div class="delete-container">
                <label for="DateOlder">Delete data older than:</label>
                <input id="DateOlder" type="date">
                <button onclick="confirmDelete()">Save</button>
            </div>

            <form id="uploadForm" method="POST" enctype="multipart/form-data">
                <label for="Flights">Choose a file:</label>
                <input type="file" name="Flights" id="Flights">
                <input type="file" name="Landings" id="Landings">
                <input type="button" value="Upload" onclick="uploadFile()">
            </form>

            <div class="scenebutton">
                <p class="scenebutton">amount of planes in scene: </p>
                <input class="scenebutton" type="number" id="sortamount" min="0" max="100">
                <button class="scenebutton" onclick="downloadScene()">download example scene file</button>
            </div>

        </div>
    </div>
</body>
</html>
<script>
    let pagenumber = 1;
    let pagesize = 10;
    let page = document.getElementById("page");
    let deleterow = ["", ''];
    let sortOrder = 'asc'; // Default sorting order
    let rowcount


    function downloadScene() {
        let sortamount = document.getElementById("sortamount").value;
        fetch(`http://127.0.0.1:5000/scene/scene?sortamount=${sortamount}`, {
            method: 'GET'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            // Assuming the response is a file, trigger the download
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'scenefile.scn'; // Set the desired filename
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Error downloading scene file:', error.message);
        });
    }


    function uploadFile() {
        const formData = new FormData(document.getElementById('uploadForm'));

        fetch('http://127.0.0.1:5000/scene/upload', {
            method: 'POST',
            body: formData
        })
    }
    // Clear file input fields after upload
    document.getElementById("Flights").value = '';
    document.getElementById("Landings").value = '';

    function myfunction(self) {
        const option = document.createElement("option");
        option.value = self;
        option.id = "existing";
        document.getElementById("airlines").appendChild(option);
    }

    function pageup() {
        if (pagenumber < rowcount) {
            pagenumber = pagenumber + 1;
            fetchData(pagenumber, pagesize, sortOrder);
            page.innerText = "page: " + pagenumber;
        }
    }

    function pagedown() {
        if (pagenumber > 1) {
            pagenumber = pagenumber - 1;
            fetchData(pagenumber, pagesize, sortOrder);
            page.innerText = "page: " + pagenumber;
        }
    }

    async function fetchData(pageNumber, pageSize, order) {
        try {
            let url = `http://127.0.0.1:5000/scene/complete/table?pageNumber=${pageNumber}&pageSize=${pageSize}&sortBy=${cellContent}&DeleteOlder=${document.getElementById("DateOlder").value}&Deleterow=${deleterow[1].innerHTML}&order=${order}`;
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const responseData = await response.json();

            // Call your function to update the table with the response data
            processData(responseData.data);
            rowcount = responseData.pagenumber
            console.log(rowcount)
        } catch (error) {
            console.error('Error fetching paginated data:', error.message);
        }
    }

    let haschanged = false;
    let cellContent;

    function processData(csv) {
        const allTextLines = csv.split(/\r\n|\n/);
        let lines = [];
        while (allTextLines.length) {
            let line = allTextLines.shift().split(',');
            lines.push(line);
        }

        drawOutput(lines);
    }

    function drawOutput(lines) {
        // Clear previous data
        document.getElementById("output").innerHTML = "";

        const table = document.createElement("table");
        table.className = "FullTable";

        for (let i = 0; i < lines.length - 1; i++) {
            const row = table.insertRow(-1);
            row.id = i.toString();
            row.className = "fullcsv";

            if (i === 0) {
                // Handling click for the header row
                row.insertCell(-1).innerHTML = '';
                row.firstChild.id = "buttons";
                row.onclick = function (event) {
                    if (event.target.tagName === "TD" && event.target.id !== "buttons") {
                        if (cellContent === event.target.innerHTML) {
                            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            cellContent = event.target.innerHTML;
                            sortOrder = 'asc';
                        }
                        fetchData(1, pagesize, sortOrder);
                    }
                };
            } else if (i <= pagesize) {
                // Buttons for non-header rows
                row.insertCell(-1).innerHTML =
                    '<button onclick="editData(this)">Edit</button>' +
                    '<button onclick="deleteData(this)">Delete</button>';
            }
            for (let j = 0; j < lines[i].length; j++) {
                const cell = row.insertCell(-1);
                cell.appendChild(document.createTextNode(lines[i][j]));
            }
        }
        document.getElementById("output").appendChild(table);
    }

    async function deleteData(button) {
        // Get the parent row of the clicked button
        let row = button.parentNode.parentNode;
        deleterow = row.children;
        // Remove the row from the table
        row.parentNode.removeChild(row);
        haschanged = true;
        let url = `http://127.0.0.1:5000/scene/complete/table?Deleterow=${deleterow[1].innerHTML}`;
        await fetch(url);
    }

    function editData(button) {
    haschanged = true;
    let row = button.parentNode.parentNode;

    // Create a form element
    let form = document.createElement("form");
    form.className = "editform"
    let fields

    // Define the fields you want to edit
    if (row.cells[6].innerHTML === "EHAM")
        fields = ["Callsign", "Operator", "ICAOType", "ADEP", "DEST", "TAS", "RFL", "WeightClass", "RunWay", "GATE", "STACK"];
    else
        fields = ["Callsign", "Operator", "ICAOType", "ADEP", "DEST", "TAS", "RFL", "WeightClass"];

    // Iterate over the fields and create textboxes for each
    fields.forEach(field => {
        let label = document.createElement("label");
        label.textContent = `Enter the new ${field}: `;
        let input = document.createElement("input");
        input.type = "text";
        input.value = row.cells[field === "RunWay" ? 11 : fields.indexOf(field) + 2].innerHTML; // Adjust the cell index for RunWay
        input.name = field;
        form.appendChild(label);
        form.appendChild(input);
        form.appendChild(document.createElement("br"));
    });

    // Add a submit button to the form
    let submitButton = document.createElement("button");
    submitButton.textContent = "Submit";
    form.appendChild(submitButton);

    // Create a modal overlay
    let modalOverlay = document.createElement("div");
    modalOverlay.classList.add("modal-overlay");

    // Display the form in the modal overlay
    modalOverlay.appendChild(form);
    document.body.appendChild(modalOverlay);

    // Handle the form submission
    form.addEventListener("submit", function (event) {
        event.preventDefault();

        // Extract values from the form
        let updatedData = { FLIGHT_ID: row.cells[1].innerHTML };
        fields.forEach(field => {
            updatedData[field] = form.elements[field].value;
        });
        console.log(JSON.stringify(updatedData))
        // Perform the fetch request
        fetch('http://127.0.0.1:5000/scene/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedData),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(data.message);
            // Optionally update your UI based on the response
        })
        .catch(error => {
            console.error('Error updating data:', error.message);
        });

        // Remove the modal overlay after submission
        document.body.removeChild(modalOverlay);
    });
}




    function confirmDelete() {
        const deleteDate = document.getElementById("DateOlder").value;
        const confirmation = window.confirm(`Are you sure you want to delete all data older than ${deleteDate}?`);

        if (confirmation) {
            // User confirmed, proceed with deletion
            fetchData(pagenumber, pagesize, sortOrder);
        }
        // If not confirmed, do nothing
    }

    // Fetch paginated data when the page loads
    fetchData(1, 10, sortOrder);
</script>
